{% extends 'base.html' %}
{% block title %}Patient Dashboard{% endblock %}
{% block content %}
<h2>Patient Dashboard</h2>
<p>Book appointments & view prescriptions.</p>
<div class="mb-3">
  <a class="btn btn-outline-primary" href="{{ url_for('main.book_appointment') }}">Book Appointment</a>
</div>
<div id="notifications" class="mb-3"></div>
{% if appointments %}
  <div class="card p-3 shadow-sm">
    <h5>My Appointments</h5>
    <table class="table">
      <thead><tr><th>ID</th><th>Doctor</th><th>Date</th><th>Time</th><th>Status</th></tr></thead>
      <tbody>
      {% for a in appointments %}
        <tr>
          <td>{{ a.id }}</td>
          <td>{{ a.doctor_name or 'â€”' }}</td>
          <td>{{ a.date }}</td>
          <td>{{ a.time }}</td>
          <td>{{ a.status }}</td>
          {% if a.status in ['prescribed','completed'] %}
            <td><a class="btn btn-outline-secondary btn-sm" href="{{ url_for('main.prescription_pdf', appointment_id=a.id) }}">Download Rx (PDF)</a>
            </td>
          {% endif %}
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="card p-3 shadow-sm">
    <p class="text-muted">No appointments found. Use the button above to book one.</p>
  </div>
{% endif %}
{% block scripts %}
<script>
async function loadNotifications(){
  try{
    const res = await fetch('/notifications');
    if(!res.ok) return;
    const notes = await res.json();
    const root = document.getElementById('notifications');
    if(!root) return;
    root.innerHTML = '';
    if(notes.length===0){ root.innerHTML = '<div class="alert alert-info">No notifications</div>'; return; }
    let list = '<div class="card p-3 shadow-sm"><h5>Notifications</h5><ul class="list-group">';
    for(const n of notes){
      list += `<li class="list-group-item ${n.is_read? 'text-muted':''}">${n.message} <br/><small class="text-muted">${n.created_at}</small></li>`;
    }
    list += '</ul><div class="mt-2 text-end"><button id="markRead" class="btn btn-sm btn-outline-primary">Mark all read</button></div></div>';
    root.innerHTML = list;
    document.getElementById('markRead')?.addEventListener('click', async ()=>{ await fetch('/notifications/mark_read',{method:'POST'}); loadNotifications(); });
  }catch(e){ console.error(e); }
}

loadNotifications();
setInterval(loadNotifications, 10000); // poll every 10s
</script>
{% endblock %}
{% endblock %}
